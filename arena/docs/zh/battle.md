
## Buff（战斗状态容器）

- `Buff` 负责存储 13 种异常状态的共存关系与能力等级（-6~+6）。
- 异常共存：
  - 控制类异常：混乱/冰冻/恐惧/睡眠/沉睡（特殊睡眠）/迷惑/麻醉/烧伤；
  - 非控制类异常：中毒/剧毒/诅咒/寄生；
  - 束缚独立存在，可与其他12种共存。
- 免疫规则：冰免冰冻；火/神火免烧伤；草/神草免寄生；毒/机械免中毒、剧毒。`ImmunityProfile::fromAttrs` 会自动生成属性免疫；技能/组件可追加免疫，或开启`ignoreAllAilments` `ignoreNegativeStages`以无视异常/能力降低（单免与双免）。
- 标签：`doubleLoss`（双损，使用技能额外消耗 1 PP）、`immuneExpel`（免疫驱逐/强制换宠）、`stageLocked`（锁定强化，正负强化均无效，高于免疫负面）。
- 主要接口：`applyAilment` / `hasAilment` / `clearPrimary` / `clearSecondary` / `clearTrapped` / `changeStage` / `resetStages`，以及 `ImmunityProfile` 构建辅助。
- 非控制规则（`onEndTurnNonControl` / `onPowerDamageTaken` / `onSwitchOut` 辅助）：
  - 诅咒：施加时对手受当前精力 $1/8$；每回合自身受 $maxHP/4$（上限 500）；阵亡/换下清除。
  - 寄生：每回合自身受 $maxHP*0.125$ 并为对手回复同量，持续 8 回合。
  - 剧毒：每回合受 $maxHP*0.0625*$层数（上限 500），层数每回合+1；换下/净化重置层数。
  - 中毒：每回合受 $maxHP*0.125$（上限 200）。
  - 烧伤：首回合物攻 -2（穿透免疫/锁定）；每回合受 $maxHP*0.125$（上限 200）；受到水/神水威力伤害时清除。
- 控制规则（`onTurnStart`/`onPowerDamageTaken` / `shouldRedirectConfusion` 提供计算）：
  - 睡眠：不可行动；从下一回合起每回合 20% 解除，最长 4 回合；受到威力伤害立即解除（单属性光系造成的威力伤害不解除）。
  - 沉睡：不可行动；从下一回合起每回合 20% 解除，最长 4 回合；受到威力伤害不解除。
  - 迷惑：从下一回合起每回合 50% 不能行动（无自动解除上限）。
  - 恐惧：不可行动；从下一回合起每回合 40% 解除，最长 4 回合。
  - 混乱：敌方技能 50% 改为作用自身；每回合 40% 解除，最长 4 回合。
  - 冰冻：不可行动；每回合 20% 解除；受到火/神火系宠物的威力伤害立即解除。
  - 麻醉：从下一回合起每回合 50% 不能行动；首次施加时速度 -1 级，强制穿透负面免疫和强化锁定。
- `Pet` 内嵌 `Buff`，便于在战斗流程直接修改。
- 强弱化实现：实现强（弱）化等级`statStages`（根据 RS 结构体构建`kStatCount`长度`std::Array`，使用`statStages[idx]`对强（弱）化状态进行索引与修改）。